import React from 'react';
import axios from 'axios';
import { Typography, Button } from '@material-ui/core';
import { Alert } from '@material-ui/lab';
import './Home.scss';
import CardDisplay from '../../components/CardDisplay';
import AddPostDialog from '../../components/AddPostDialog';
import CopyLinkDialog from '../../components/CopyLinkDialog';

class Home extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      isAddingScenario: false,
      isCopyingLink: false,
      isErrorOnFetch: false,
      hasMoreScenarios: true,
      isFetching: false,
    };
  }
  
  componentDidMount() {
    this.fetchScenarioData();
  }

  fetchScenarioData = async () => {
    try {
      const { lastDate, scenarios, isFetching, hasMoreScenarios } = this.state;

      if (isFetching || !hasMoreScenarios) {
        return;
      }

      this.setState({ isFetching: true });

      const params = lastDate ? `?lastDate=${lastDate}` : '';
      const response = await axios.get(`/api/scenario${params}`);

      if (!response.data.scenarios) {
        throw new Error();
      }

      const newScenarios = scenarios ? scenarios.concat(response.data.scenarios) : response.data.scenarios;

      this.setState({
        scenarios: newScenarios,
        hasMoreScenarios: response.data.scenarios && response.data.scenarios.length > 0,
        lastDate: newScenarios.slice(-1)[0].dateCreated._seconds,
        isErrorOnFetch: false,
        isFetching: false,
      });
    } catch {
      this.setState({
        isErrorOnFetch: true,
        hasMoreScenarios: false,
        isFetching: false,
      });
    }
  }

  handleNewScenario = (scenario) => {
    const { scenarios } = this.state;

    const newScenario = [{
      reports: 0,
      likes: 0,
      responses: [],
      dateCreated: { _seconds: Math.round(new Date() / 1000) - 3 },
      ...scenario,
    }];

    this.setState({ scenarios: newScenario.concat(scenarios), docIdToCopy: scenario.id });
    this.handleCopyLinkDialogOpen();
  }

  handleNewScenarioDialogOpen = () => {
    this.setState({ isAddingScenario: true });
  }

  handleNewScenarioDialogClose = () => {
    this.setState({ isAddingScenario: false });
  }

  handleCopyLinkDialogOpen = () => {
    this.setState({ isCopyingLink: true });
  }

  handleCopyLinkDialogClose = () => {
    this.setState({ isCopyingLink: false });
  }

  render() {
    const {
      scenarios,
      isAddingScenario,
      hasMoreScenarios,
      isErrorOnFetch,
      isCopyingLink,
      docIdToCopy,
    } = this.state;

    const isInternetExplorer = false || !!document.documentMode;

    return (
      <div className="Home">
        {isInternetExplorer && <Alert severity="error">Internet Explorer is not a supported browser. Please consider using a browser like Google Chrome, Firefox, or Microsoft Edge.</Alert>}

        <div className="home-copy">
          <div className="intro">
            <Typography variant="h1" id="intro-2">
              Healthcare workers, how&apos;s your day, <span className="purp">really?</span>
            </Typography>

            <Typography variant="body1" id="intro-3">
              We&apos;re here to listen. SafeHealthyKind is a safe space for you to share your experiences, frustrations, and fears, and get support from your peers.
            </Typography>

            <div className="share-cta">
              <Button onClick={this.handleNewScenarioDialogOpen}>SHARE YOUR STORY</Button>
            </div>
          </div>

          <svg className="desktop-ill" width="597" height="751" viewBox="0 0 597 751" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g opacity="0.56">
              <path fillRule="evenodd" clipRule="evenodd" d="M324.759 510.758C448.812 510.758 549.376 410.193 549.376 286.141C549.376 162.089 448.812 61.5249 324.759 61.5249C200.707 61.5249 100.143 162.089 100.143 286.141C100.143 410.193 200.707 510.758 324.759 510.758Z" fill="#FF9B21" fillOpacity="0.6"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M389.215 751C411.328 751 429.255 733.073 429.255 710.96C429.255 688.846 411.328 670.919 389.215 670.919C367.101 670.919 349.174 688.846 349.174 710.96C349.174 733.073 367.101 751 389.215 751Z" fill="#3643C0"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M287.649 0L335.502 47.8531L287.649 95.7061L239.796 47.8531L287.649 0Z" fill="#3643C0"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M154.832 663.849L178.27 687.287L154.832 710.726L131.394 687.287L154.832 663.849Z" fill="#FF9B21" fillOpacity="0.8"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M493.71 61.5249L505.429 73.244L493.71 84.9631L481.991 73.244L493.71 61.5249Z" fill="#4FC4CF"/>
              <path fillRule="evenodd" clipRule="evenodd" d="M59 331C68.9411 331 77 322.941 77 313C77 303.059 68.9411 295 59 295C49.0589 295 41 303.059 41 313C41 322.941 49.0589 331 59 331Z" fill="#4FC4CF"/>
            </g>
            <path fillRule="evenodd" clipRule="evenodd" d="M170.251 281.854C178.017 286.545 185.647 288.812 189.228 287.887C198.209 285.566 199.035 252.635 192.086 239.652C185.137 226.67 149.412 221.011 147.612 246.734C146.987 255.661 150.727 263.628 156.253 270.13L146.344 316.417H175.125L170.251 281.854Z" fill="#B28B67"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M171.69 249.575C174.179 245.859 176.569 243.026 179.678 241.38C192.331 241.58 193.813 239.307 193.813 231.644C191.769 230.178 184.558 227.71 176.483 227.016C172.363 225.834 167.483 226.057 162.782 228.028C156.979 229.678 152.065 233.232 149.895 239.886C142.042 253.469 148.002 267.609 156.034 272.439C158.172 269.9 160.038 267.439 161.703 265.084C160.366 263.775 159.536 261.947 159.536 259.925C159.536 255.942 162.757 252.713 166.731 252.713C167.023 252.713 167.311 252.731 167.594 252.765C167.773 257.744 168.509 274.592 170.442 280.444C172.721 287.344 186.018 289.038 190.656 289.038C194.662 289.038 194.526 285.236 194.428 282.511C194.414 282.118 194.4 281.748 194.4 281.415C194.4 280.719 193.497 280.721 192.477 280.723C191.151 280.725 189.628 280.728 189.628 279.204C189.628 277.543 191.919 276.269 193.968 275.129C195.247 274.417 196.432 273.758 196.909 273.089C198.412 270.98 198.918 268.136 196.65 268.136C195.411 268.136 193.71 268.852 191.663 269.714C188.574 271.015 184.698 272.647 180.433 272.647C173.386 272.647 171.711 249.86 171.69 249.575Z" fill="#191847"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M102.141 454.652H186.893L197.998 590.78H71.8381L102.141 454.652Z" fill="#C5CFD6"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M102.141 454.652H128.207L143.808 590.78H71.8381L102.141 454.652Z" fill="black" fillOpacity="0.16"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M233.458 481.621C223.934 501.834 209.052 550.899 209.052 550.899L221.686 556.675C221.686 556.675 253.743 505.099 273.334 469.842C272.421 477.779 271.492 486.715 270.63 496.108C268.589 518.361 270.629 566.438 271.727 580.326C272.417 589.054 284.269 587.226 285.375 580.304C285.562 579.131 286.326 575.015 287.465 568.873C293.053 538.758 307.676 459.941 307.702 440.642C307.712 432.877 292.552 425.9 283.516 431.33C277.309 424.703 265.562 420.883 258.813 431.831C254.523 438.79 244.329 458.549 233.458 481.621Z" fill="#B28B67"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M209.955 532.734L253.319 429.937C263.707 413.215 292.833 433.34 289.29 443.039C281.247 465.058 240.343 536.345 237.947 542.905L209.955 532.734Z" fill="#1F28CF"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M210.669 544.706C209.981 543.758 208.64 543.533 207.742 544.284C205.946 545.786 203.235 548.206 202.276 549.869C200.792 552.441 198.802 557.869 198.802 557.869C201.783 559.592 252.387 588.828 252.387 588.828C252.387 588.828 258.462 583.125 254.28 579.974C250.098 576.823 247.377 574.659 247.377 574.659L228.823 549.078C228.492 548.622 227.85 548.529 227.404 548.873L223.482 551.895C223.482 551.895 218.193 551.433 215.589 549.928C213.951 548.982 211.938 546.453 210.669 544.706Z" fill="#F8F8F8"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M271.801 573.443C270.731 572.966 269.457 573.442 269.055 574.542C268.25 576.742 267.111 580.194 267.111 582.114C267.111 585.084 268.1 590.781 268.1 590.781C271.542 590.781 329.975 590.781 329.975 590.781C329.975 590.781 332.387 582.801 327.19 582.165C321.994 581.529 318.557 581.016 318.557 581.016L289.707 568.146C289.192 567.916 288.59 568.157 288.375 568.678L286.488 573.258C286.488 573.258 281.678 575.504 278.67 575.504C276.779 575.504 273.773 574.321 271.801 573.443Z" fill="#F8F8F8"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M310.741 448.54C310.741 477.706 296.9 545.738 296.891 552.16L267.111 552.182C267.111 552.182 273.65 461.127 271.748 460.146C269.847 459.165 193.802 467.743 170.996 467.743C138.108 467.743 124.503 446.99 123.399 408.544H188.548C201.813 409.964 271.004 423.93 296.701 428.731C307.702 430.786 310.741 440.506 310.741 448.54Z" fill="#2B44FF"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M53.5883 447.279C57.6796 441.264 81.3464 377.296 81.3464 377.296L100.777 380.12C100.777 380.12 69.4915 448.046 67.232 451.966C64.2968 457.059 66.893 465.423 68.6535 471.095C68.9259 471.972 69.1782 472.785 69.387 473.512C65.6889 474.58 64.2821 472.462 62.7989 470.229C61.1236 467.707 59.351 465.038 54.0696 466.649C52.0291 467.271 50.0687 468.07 48.1534 468.851C41.5376 471.549 35.4599 474.027 28.4793 468.232C27.3727 467.314 26.4404 464.31 29.958 462.559C38.7214 458.199 51.5882 450.22 53.5883 447.279ZM264.419 417.548L231.303 389.453L222.252 408.002L255.818 424.766C264.792 436.943 269.924 442.116 271.214 440.286C272.303 438.744 271.645 437.182 271.04 435.744C270.568 434.624 270.128 433.578 270.569 432.674C271.576 430.61 278.128 431.293 284.317 432.208C290.507 433.122 288.887 430.224 287.482 428.751C281.396 424.501 273.708 420.767 264.419 417.548Z" fill="#B28B67"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M162.558 298.03L174.598 294.046C190.93 334.873 215.288 374.376 255.984 407.743L245.92 425.118C210.154 404.034 176.297 387.656 162.558 356.019C157.947 345.401 162.182 310.726 162.558 298.03Z" fill="#B9C0C4"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M121.205 412.935C121.205 412.935 172.939 418.424 202.645 412.935C205.099 412.482 205.486 408.371 204.348 405.581C186.628 362.133 174.478 324.223 174.478 294.045C169.601 296.506 157.407 294.783 157.407 294.783C135.561 325.882 125.519 361.565 121.205 412.935Z" fill="#323337"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M151.147 292.176C151.711 291.796 152.008 291.607 152.008 291.607L151.976 292.176H161.081C161.538 294.869 162.208 304.848 163.185 319.4C166.736 372.278 174.341 485.53 190.528 528.871H78.8432C81.1997 479.596 99.3538 420.671 118.16 370.637C104.283 384.454 88.0758 407.614 74.9778 446.169L54.0581 440.795C75.3772 348.865 137.838 301.455 149.958 292.993C150.076 292.719 150.194 292.447 150.311 292.176H151.147Z" fill="#DDE3E9"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M410.823 233.65C403.538 238.041 396.38 240.162 393.02 239.296C384.594 237.125 383.82 206.302 390.339 194.151C396.858 181.999 430.372 176.703 432.061 200.779C432.647 209.134 429.139 216.592 423.955 222.676L433.25 266H406.25L410.823 233.65Z" fill="#915B3C"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M378.377 177.305C378.936 175.34 380.44 173.657 382.467 173.158C382.959 173.037 383.466 172.988 383.972 173.009C384.153 173.016 384.204 173.068 384.289 172.941C384.352 172.847 384.353 172.618 384.379 172.507C384.46 172.163 384.56 171.824 384.685 171.493C385.109 170.366 385.821 169.368 386.68 168.527C388.287 166.954 390.458 165.869 392.714 165.672C393.949 165.565 395.174 165.766 396.342 166.167C396.946 166.375 397.532 166.634 398.103 166.92C398.274 167.006 398.832 167.428 399.004 167.401C399.195 167.371 399.577 166.897 399.732 166.779C401.646 165.31 404.01 164.733 406.394 164.75C409.085 164.77 411.676 164.905 413.921 166.545C414.396 166.892 414.848 167.273 415.279 167.673C415.506 167.884 415.726 168.103 415.935 168.33C416.062 168.468 416.185 168.608 416.303 168.753C416.504 168.998 416.472 169.078 416.754 168.907C417.834 168.251 419.085 167.944 420.346 168.099C421.095 168.191 421.823 168.416 422.515 168.712C422.75 168.812 423.295 169.214 423.546 169.218C423.795 169.222 424.333 168.849 424.589 168.755C425.974 168.243 427.467 168.117 428.923 168.354C430.425 168.597 431.9 169.197 433.172 170.025C433.784 170.423 434.318 170.864 434.747 171.456C434.932 171.712 435.1 171.983 435.31 172.22C435.433 172.358 435.676 172.501 435.742 172.677C435.702 172.571 437.384 171.923 437.543 171.882C438.389 171.661 439.249 171.705 440.077 171.978C441.634 172.49 442.973 173.639 444.074 174.817C444.639 175.422 445.134 176.091 445.553 176.804C445.755 177.145 445.939 177.496 446.107 177.855C446.188 178.028 446.243 178.246 446.35 178.402C446.489 178.604 446.582 178.608 446.833 178.696C448.107 179.142 449.268 179.898 450.153 180.919C451.047 181.951 451.628 183.224 451.871 184.563C451.886 184.642 451.894 184.969 451.94 185.012C452.004 185.07 452.26 185.044 452.357 185.056C452.693 185.095 453.026 185.154 453.355 185.232C453.961 185.375 454.551 185.586 455.109 185.862C457.285 186.939 458.841 188.957 459.602 191.228C460.401 193.611 460.387 196.342 459.432 198.681C459.278 199.058 459.094 199.425 458.879 199.772C458.746 199.985 458.704 199.985 458.79 200.209C458.886 200.457 459.061 200.699 459.174 200.942C459.546 201.734 459.805 202.575 459.969 203.433C460.238 204.841 460.371 206.321 460.106 207.74C459.983 208.399 459.768 209.043 459.441 209.63C459.274 209.929 459.078 210.213 458.858 210.476C458.743 210.612 458.622 210.742 458.494 210.867C458.422 210.938 458.326 211 458.264 211.08C458.113 211.274 458.082 211.114 458.16 211.399C458.268 211.798 458.515 212.191 458.666 212.578C458.822 212.978 458.963 213.382 459.092 213.791C459.352 214.619 459.573 215.462 459.711 216.319C459.976 217.966 459.929 219.72 459.15 221.23C458.817 221.877 458.34 222.444 457.761 222.885C457.477 223.1 457.17 223.286 456.848 223.439C456.682 223.518 456.471 223.551 456.395 223.711C456.314 223.883 456.435 224.225 456.462 224.418C456.702 226.092 456.822 227.85 456.324 229.491C455.866 231.002 454.856 232.336 453.546 233.22C451.004 234.933 447.577 234.837 444.906 233.465C444.21 233.107 443.559 232.663 442.978 232.139C441.498 234.131 438.453 234.068 436.291 233.501C433.596 232.794 431.435 230.92 430.189 228.459C428.486 230.532 424.912 229.859 423.73 227.61C423.441 227.06 423.27 226.453 423.186 225.839C423.141 225.516 423.169 225.191 423.136 224.87C423.093 224.462 422.821 224.066 422.664 223.671C422.359 222.902 422.169 222.109 422.161 221.28C422.157 220.847 422.212 220.425 422.253 219.996C422.29 219.61 422.183 219.25 422.122 218.868C422.813 218.982 423.655 218.796 424.306 218.595C424.945 218.399 425.543 217.881 425.994 217.408C427.041 216.31 427.68 214.87 428.118 213.438C429.078 210.293 428.684 206.52 425.521 204.794C424.048 203.99 419.634 203.993 417.879 204.39C416.033 204.808 413.942 208.88 413.839 209.262C413.775 209.499 413.807 209.792 413.589 209.95C413.111 210.297 412.323 209.695 411.97 209.398C411.361 208.885 410.927 208.202 410.551 207.511C409.732 206.003 409.071 204.387 408.605 202.737C408.245 201.465 408.015 200.153 407.545 198.914C407.077 197.68 406.34 196.578 405.193 195.879C403.946 195.119 402.516 194.718 401.146 194.241C399.789 193.767 398.455 193.188 397.403 192.184C397.172 191.963 396.947 191.728 396.761 191.468C396.614 191.263 396.469 190.87 396.245 190.74C395.896 190.537 395.388 191.064 395.087 191.255C393.602 192.198 392.362 193.514 391.363 194.952C390.369 196.381 389.553 197.757 388.89 199.353C388.399 200.537 388.092 202.053 387.227 203.024C386.841 203.457 383.972 203.719 383.042 203.341C382.113 202.963 381.071 201.98 380.759 201.365C380.44 200.735 380.364 200.043 380.5 199.353C380.58 198.948 380.744 198.568 380.834 198.17C380.91 197.835 380.978 197.519 381.141 197.212C381.45 196.631 381.977 196.213 382.614 196.039C381.952 195.428 381.403 194.698 381.023 193.881C380.629 193.033 380.294 192.002 380.2 191.071C380.122 190.315 380.242 189.531 380.655 188.882C381.09 188.2 381.859 187.755 382.524 187.33C381.508 186.535 380.638 185.567 379.922 184.496C378.531 182.414 377.671 179.788 378.377 177.305Z" fill="#191847"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M453.213 354L412.487 497.197L382.773 602.741H361.1L392.676 354H453.213Z" fill="#1D2785"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M464.105 354C465.047 427.805 468.259 468.061 469.248 474.766C470.237 481.472 485.192 524.13 514.113 602.741H491.662C454.843 527.327 434.29 484.669 430.002 474.766C425.715 464.864 412.483 424.608 392.553 354H464.105Z" fill="#3643C0"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M516.12 623L514.997 599.364L491.407 599.364C474.628 611.182 447.597 618.498 447.597 618.498V623H490.283L504.887 620.749V623H516.12Z" fill="#191847"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M385.813 623L384.69 599.364L361.1 599.364C344.321 611.182 317.29 618.498 317.29 618.498V623H359.977L374.58 620.749V623H385.813Z" fill="#191847"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M542.996 380.422C538.102 375.041 505.737 315.058 505.737 315.058L486.86 320.56C486.86 320.56 527.331 383.397 530.117 386.961C533.736 391.59 532.324 400.226 531.366 406.082C531.218 406.988 531.081 407.828 530.975 408.575C534.791 409.117 535.892 406.826 537.052 404.41C538.363 401.681 539.75 398.794 545.212 399.651C547.322 399.982 549.377 400.5 551.385 401.005C558.321 402.752 564.693 404.356 570.811 397.651C571.781 396.588 572.287 393.486 568.556 392.245C559.258 389.153 545.388 383.052 542.996 380.422ZM329.774 380.395L358.71 347.986L370.265 365.075L339.307 386.337C332.101 399.634 327.73 405.467 326.196 403.837C324.902 402.462 325.337 400.826 325.737 399.319C326.049 398.145 326.341 397.049 325.778 396.216C324.492 394.315 318.089 395.904 312.078 397.671C306.067 399.438 307.27 396.346 308.459 394.693C313.904 389.64 321.009 384.875 329.774 380.395Z" fill="#915B3C"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M414.176 247.961L401.682 245.698C391.161 288.364 372.497 330.838 336.776 369.519L349.172 385.305C381.712 359.462 413.012 338.541 422.239 305.329C425.335 294.182 416.315 260.469 414.176 247.961Z" fill="#B9C0C4"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M471.163 355.871C471.163 355.871 420.62 368.511 390.396 367.222C387.9 367.115 386.944 363.102 387.685 360.184C399.217 314.732 405.997 275.535 401.801 245.681C406.98 247.435 418.833 244.031 418.833 244.031C444.822 271.752 459.742 305.652 471.163 355.871Z" fill="#323337"/>
            <path fillRule="evenodd" clipRule="evenodd" d="M424.679 240.58C424.067 240.283 423.746 240.137 423.746 240.137L423.857 240.696L414.827 241.965C414.748 244.692 415.471 254.658 416.525 269.19C420.355 321.996 428.559 435.093 418.532 480.225L529.294 464.658C520.106 416.241 493.909 360.478 468.302 313.602C483.986 325.336 503.279 345.989 521.629 382.305L541.629 374.073C507.704 286.101 439.168 247.904 425.972 241.222C425.816 240.968 425.662 240.715 425.508 240.464L424.679 240.58Z" fill="#DDE3E9"/>
            <defs>
              <clipPath id="clip0">
                <rect width="596.469" height="751"/>
              </clipPath>
            </defs>
          </svg>
        </div>

        {isErrorOnFetch && <Alert severity="error">There was an error when communicating with the server. Please try again.</Alert>}

        <CardDisplay
          scenarios={scenarios}
          hasMoreScenarios={hasMoreScenarios}
          infiniteScrollFunc={this.fetchScenarioData}
        />

        <AddPostDialog
          isOpen={isAddingScenario}
          handleClose={this.handleNewScenarioDialogClose}
          submitCallback={this.handleNewScenario}
          isScenario
        />

        {docIdToCopy && <CopyLinkDialog
          isOpen={isCopyingLink}
          handleClose={this.handleCopyLinkDialogClose}
          docId={docIdToCopy}
        />}
      </div>
    );
  }
}

export default Home;  